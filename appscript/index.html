<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Convex Autograding Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.6;
        color: #1f2937;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #f35d1c 0%, #e11d48 100%);
        color: white;
        padding: 32px;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .content {
        padding: 32px;
      }

      .step {
        margin-bottom: 32px;
      }

      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        background: #f35d1c;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 12px;
      }

      .step-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }

      .form-select,
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: white;
      }

      .form-select:focus,
      .form-input:focus {
        outline: none;
        border-color: #f35d1c;
        box-shadow: 0 0 0 3px rgb(243 93 28 / 0.1);
      }

      .form-select:disabled,
      .form-input:disabled {
        background: #f9fafb;
        color: #6b7280;
        cursor: not-allowed;
      }

      .button {
        background: #f35d1c;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .button:hover {
        background: #ea580c;
        transform: translateY(-1px);
      }

      .button:disabled {
        background: #d1d5db;
        color: #6b7280;
        cursor: not-allowed;
        transform: none;
      }

      .button-secondary {
        background: #6b7280;
      }

      .button-secondary:hover {
        background: #4b5563;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #f35d1c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .success-message,
      .error-message {
        padding: 16px;
        border-radius: 8px;
        margin: 20px 0;
        display: none;
      }

      .success-message {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .info-box {
        background: #eff6ff;
        border: 1px solid #dbeafe;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        color: #1e40af;
      }

      .form-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        margin: 16px 0;
        border: 1px solid #e5e7eb;
      }

      .questions-preview {
        margin-top: 20px;
      }

      .question-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
      }

      .question-title {
        font-weight: 500;
        margin-bottom: 4px;
      }

      .question-type {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸŽ“ Autograding Setup</h1>
        <p>Configure automatic grading for your Google Classroom assignments</p>
      </div>

      <div class="content">
        <!-- Step 1: Select Classroom -->
        <div class="step">
          <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">Select Classroom</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="classroomSelect">Choose your Google Classroom:</label>
            <select id="classroomSelect" class="form-select">
              <option value="">Loading classrooms...</option>
            </select>
          </div>

          <div class="info-box" id="classroomInfo" style="display: none;">
            <strong>Selected Classroom:</strong> <span id="selectedClassroomName"></span><br>
            <strong>Course ID:</strong> <span id="selectedCourseId"></span>
          </div>
        </div>

        <!-- Step 2: Select Assignment -->
        <div class="step">
          <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">Select Assignment</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="assignmentSelect">Choose a Google Form assignment:</label>
            <select id="assignmentSelect" class="form-select" disabled>
              <option value="">First select a classroom</option>
            </select>
          </div>

          <div class="info-box" id="assignmentInfo" style="display: none;">
            <strong>Assignment:</strong> <span id="selectedAssignmentTitle"></span><br>
            <strong>Due Date:</strong> <span id="selectedDueDate"></span><br>
            <strong>Max Points:</strong> <span id="selectedMaxPoints"></span>
          </div>
        </div>

        <!-- Step 3: Form Configuration -->
        <div class="step">
          <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">Form Configuration</div>
          </div>

          <div class="form-section" id="formConfig" style="display: none;">
            <div class="form-group">
              <label class="form-label" for="formTitle">Form Title:</label>
              <input type="text" id="formTitle" class="form-input" readonly>
            </div>

            <div class="form-group">
              <label class="form-label" for="totalPoints">Total Points:</label>
              <input type="number" id="totalPoints" class="form-input" min="0">
            </div>

            <div class="questions-preview" id="questionsPreview">
              <h4 style="margin-bottom: 12px;">Questions Preview:</h4>
              <!-- Questions will be populated here -->
            </div>
          </div>
        </div>

        <!-- Loading and Messages -->
        <div class="loading" id="loadingMessage">
          <div class="spinner"></div>
          <span id="loadingText">Processing...</span>
        </div>

        <div class="success-message" id="successMessage">
          <strong>Success!</strong> <span id="successText"></span>
        </div>

        <div class="error-message" id="errorMessage">
          <strong>Error:</strong> <span id="errorText"></span>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="button" class="button button-secondary" onclick="resetForm()">
            Reset
          </button>
          <button type="button" class="button" id="configureButton" onclick="configureAutograding()" disabled>
            ðŸš€ Configure Autograding
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global state
      let classrooms = [];
      let assignments = [];
      let selectedClassroom = null;
      let selectedAssignment = null;
      let formQuestions = [];

      // Initialize the app
      document.addEventListener('DOMContentLoaded', function() {
        loadClassrooms();
      });

      // Load user's classrooms
      function loadClassrooms() {
        showLoading('Loading your classrooms...');

        google.script.run
          .withSuccessHandler(onClassroomsLoaded)
          .withFailureHandler(onError)
          .getTeacherClassrooms();
      }

      function onClassroomsLoaded(result) {
        hideLoading();

        if (!result.success) {
          showError(result.error || 'Failed to load classrooms');
          return;
        }

        classrooms = result.classrooms;
        populateClassroomSelect();
      }

      function populateClassroomSelect() {
        const select = document.getElementById('classroomSelect');
        select.innerHTML = '<option value="">Select a classroom...</option>';

        classrooms.forEach(classroom => {
          const option = document.createElement('option');
          option.value = classroom.id;
          option.textContent = classroom.name;
          select.appendChild(option);
        });

        // Enable classroom selection
        select.addEventListener('change', onClassroomSelected);
      }

      function onClassroomSelected() {
        const select = document.getElementById('classroomSelect');
        const classroomId = select.value;

        if (!classroomId) {
          hideClassroomInfo();
          return;
        }

        selectedClassroom = classrooms.find(c => c.id === classroomId);
        showClassroomInfo();
        loadAssignments(classroomId);
      }

      function showClassroomInfo() {
        if (!selectedClassroom) return;

        document.getElementById('selectedClassroomName').textContent = selectedClassroom.name;
        document.getElementById('selectedCourseId').textContent = selectedClassroom.id;
        document.getElementById('classroomInfo').style.display = 'block';
      }

      function hideClassroomInfo() {
        document.getElementById('classroomInfo').style.display = 'none';
        resetAssignmentSelection();
      }

      function loadAssignments(courseId) {
        showLoading('Loading assignments...');

        google.script.run
          .withSuccessHandler(onAssignmentsLoaded)
          .withFailureHandler(onError)
          .getFormAssignments(courseId);
      }

      function onAssignmentsLoaded(result) {
        hideLoading();

        if (!result.success) {
          showError(result.error || 'Failed to load assignments');
          return;
        }

        assignments = result.assignments;
        populateAssignmentSelect();
      }

      function populateAssignmentSelect() {
        const select = document.getElementById('assignmentSelect');
        select.innerHTML = '<option value="">Select an assignment...</option>';
        select.disabled = false;

        assignments.forEach(assignment => {
          const option = document.createElement('option');
          option.value = assignment.id;
          option.textContent = assignment.title;
          select.appendChild(option);
        });

        // Enable assignment selection
        select.addEventListener('change', onAssignmentSelected);
      }

      function onAssignmentSelected() {
        const select = document.getElementById('assignmentSelect');
        const assignmentId = select.value;

        if (!assignmentId) {
          hideAssignmentInfo();
          return;
        }

        selectedAssignment = assignments.find(a => a.id === assignmentId);
        showAssignmentInfo();
        loadFormQuestions(selectedAssignment.formId);
      }

      function showAssignmentInfo() {
        if (!selectedAssignment) return;

        document.getElementById('selectedAssignmentTitle').textContent = selectedAssignment.title;
        document.getElementById('selectedDueDate').textContent = selectedAssignment.dueDate || 'No due date';
        document.getElementById('selectedMaxPoints').textContent = selectedAssignment.maxPoints || 'Not set';
        document.getElementById('assignmentInfo').style.display = 'block';
      }

      function hideAssignmentInfo() {
        document.getElementById('assignmentInfo').style.display = 'none';
        resetFormConfiguration();
      }

      function loadFormQuestions(formId) {
        showLoading('Loading form questions...');

        google.script.run
          .withSuccessHandler(onFormQuestionsLoaded)
          .withFailureHandler(onError)
          .getFormQuestions(formId);
      }

      function onFormQuestionsLoaded(result) {
        hideLoading();

        if (!result.success) {
          showError(result.error || 'Failed to load form questions');
          return;
        }

        formQuestions = result.questions;
        showFormConfiguration(result.formInfo);
      }

      function showFormConfiguration(formInfo) {
        document.getElementById('formTitle').value = formInfo.title;
        document.getElementById('totalPoints').value = calculateTotalPoints();

        populateQuestionsPreview();
        document.getElementById('formConfig').style.display = 'block';
        document.getElementById('configureButton').disabled = false;
      }

      function populateQuestionsPreview() {
        const container = document.getElementById('questionsPreview');
        const questionsHtml = formQuestions.map((q, index) => `
          <div class="question-item">
            <div class="question-title">${index + 1}. ${q.title}</div>
            <div class="question-type">Type: ${q.type} | Points: ${q.points || 1}</div>
          </div>
        `).join('');

        container.innerHTML = `
          <h4 style="margin-bottom: 12px;">Questions Preview (${formQuestions.length} questions):</h4>
          ${questionsHtml}
        `;
      }

      function calculateTotalPoints() {
        return formQuestions.reduce((total, q) => total + (q.points || 1), 0);
      }

      function resetAssignmentSelection() {
        const select = document.getElementById('assignmentSelect');
        select.innerHTML = '<option value="">First select a classroom</option>';
        select.disabled = true;
        hideAssignmentInfo();
        resetFormConfiguration();
      }

      function resetFormConfiguration() {
        document.getElementById('formConfig').style.display = 'none';
        document.getElementById('configureButton').disabled = true;
        formQuestions = [];
      }

      function configureAutograding() {
        if (!selectedClassroom || !selectedAssignment) {
          showError('Please select both a classroom and assignment');
          return;
        }

        const totalPoints = parseInt(document.getElementById('totalPoints').value) || 0;

        const configData = {
          userId: Session.getActiveUser().getEmail(),
          courseId: selectedClassroom.id,
          courseName: selectedClassroom.name,
          courseWorkId: selectedAssignment.id,
          assignmentTitle: selectedAssignment.title,
          formId: selectedAssignment.formId,
          formTitle: document.getElementById('formTitle').value,
          questions: formQuestions,
          totalPoints: totalPoints,
          dueDate: selectedAssignment.dueDate,
          timestamp: new Date().toISOString()
        };

        showLoading('Configuring autograding...');

        google.script.run
          .withSuccessHandler(onConfigurationComplete)
          .withFailureHandler(onError)
          .sendConfigurationToConvex(configData);
      }

      function onConfigurationComplete(result) {
        hideLoading();

        if (result.success) {
          showSuccess(`Autograding configured successfully! ${result.message}`);
        } else {
          showError(result.error || 'Configuration failed');
        }
      }

      function resetForm() {
        location.reload();
      }

      // Utility functions
      function showLoading(message) {
        document.getElementById('loadingText').textContent = message;
        document.getElementById('loadingMessage').style.display = 'block';
        hideMessages();
      }

      function hideLoading() {
        document.getElementById('loadingMessage').style.display = 'none';
      }

      function showSuccess(message) {
        document.getElementById('successText').textContent = message;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
      }

      function showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }

      function hideMessages() {
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
      }

      function onError(error) {
        hideLoading();
        showError(error.message || error.toString());
      }
    </script>
  </body>
</html>